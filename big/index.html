<!-- -*- mode: web -*-  -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
  </head>
  <body>
    <div id="plot"></div>
  </body>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="plot_xy.js?ver=1" charset="utf-8"></script>
  <script>
   var e0,e1,nx,ny,new_nodes,current_node,node_routes,
       total_time=0;
   var callback = function(data) {
     var dist = 1e100,
         closest_node=-1;
     for (var i=0; i<new_nodes.length; i++) {
       var cx = nx[new_nodes[i]],
           cy = ny[new_nodes[i]],
           local_dist = (cx-data.x)*(cx-data.x) + (cy-data.y)*(cy-data.y);
       if (local_dist < dist) {
         dist = local_dist;
         closest_node = i;
       }
     }
     //d3.select("#node"+new_nodes[closest_node]).remove();
     d3.select("#node"+new_nodes[closest_node]).attr("fill", "#000");
     var previous_node = current_node;
     current_node = new_nodes[closest_node];
     new_nodes = new_nodes.filter(function(item) {return item !== current_node});
     // now draw from old node to current node
     var key= Math.min(current_node, previous_node)+":"+Math.max(current_node, previous_node);
     total_time += node_routes[key][0];
     var new_path = node_routes[key][1];
   };
   d3.json("roads.json").then((data) => {
     console.log(data);
     var xmin = data["limits"][0],
         xmax = data["limits"][1],
         ymin = data["limits"][2],
         ymax = data["limits"][3],
         lines = [],
         px = [],
         py = [];

     e0 = data["e0"];
     e1 = data["e1"];
     nx = data["nx"];
     ny = data["ny"];
     new_nodes = data["new_nodes"];
     node_routes = data["node_routes"];
     for (var i=0; i<e0.length; i++) {
       p0 = [[nx[e0[i]], nx[e1[i]]],
             [ny[e0[i]], ny[e1[i]]]];
       lines.push(p0);
     }
     for (var i=0; i<new_nodes.length; i++) {
       px.push([nx[new_nodes[i]], ny[new_nodes[i]], new_nodes[i]]);
     }

     plot_xy("#plot", lines,
             options={ x_label: "",
                       y_label: "",
                       circle_arrays: [px],
                       circle_arrays_colors: [d3.color("red")],
                       ymin: ymin,
                       ymax: ymax,
                       xmin: xmin,
                       xmax: xmax,
                       colors: [d3.color("grey")],
                       height: 800,
                       width: 800,
                       callback: callback,
                       padding: {top: 0, right: 0, bottom: 0, left: 0},});
     d3.select("#node"+new_nodes[new_nodes.length-1]).attr("fill", "#000");
     current_node = new_nodes[new_nodes.length-1];
     new_nodes = new_nodes.filter(function(item) {return item !== current_node});
   });
  </script>
</html>
