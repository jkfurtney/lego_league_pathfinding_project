<!-- -*- mode: web -*-  -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>v5</title>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <style>

     .svg {cursor: pointer; }
    </style>

  </head>
  <body>
    <div id="plot"></div>
    <div id="messages"></div>
  </body>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="plot_xy.js?ver=1.1" charset="utf-8"></script>
  <script>
   var e0,e1,nx,ny,new_nodes,current_node,node_routes,
       valueline, xscale, yscale, total_time=0;

   var add_segments = function(datasets) {
     datasets.forEach(function (d, i) {
       let xarray = d[0];
       let yarray = d[1];
       var chart = d3.select("#plot svg");
       let path = chart.append("path")
                       .attr("class", "line")
                       .attr("stroke", "#000")
                       .attr("stroke-width", '5px')
                       .attr("fill", 'none')
                       .attr("d", valueline(xarray, yarray, xscale, yscale));
     });
   }

   var callback = function(data) {
     d3.select("#messages").append("div").text("got click 0");
     var dist = 1e100,
         closest_node=-1;
     for (var i=0; i<new_nodes.length; i++) {
       var cx = nx[new_nodes[i]],
           cy = ny[new_nodes[i]],
           local_dist = (cx-data.x)*(cx-data.x) + (cy-data.y)*(cy-data.y);
       if (local_dist < dist) {
         dist = local_dist;
         closest_node = i;
       }
     }
     //d3.select("#node"+new_nodes[closest_node]).remove();
     d3.select("#node"+new_nodes[closest_node]).attr("fill", "#000");
     var previous_node = current_node;
     current_node = new_nodes[closest_node];
     new_nodes = new_nodes.filter(function(item) {return item !== current_node});
     // now draw from old node to current node
     var key = Math.min(current_node, previous_node)+":"+Math.max(current_node, previous_node);
     total_time += node_routes[key][0];
     console.log(total_time);
     var path = node_routes[key][1];
     var lines=[];
     for (var i=0; i<path.length-1; i++) {
       p0 = [[nx[path[i]], nx[path[i+1]]],
             [ny[path[i]], ny[path[i+1]]]];
       lines.push(p0);
     }
     add_segments(lines);
   };
   d3.json("roads.json").then((data) => {
     var xmin = data["limits"][0],
         xmax = data["limits"][1],
         ymin = data["limits"][2],
         ymax = data["limits"][3],
         dx = xmax-xmin,
         dy = ymax-ymin,
         lines = [],
         px = [],
         py = [],
         width=1000,
         height=parseInt(width*dy/dx);

     e0 = data["e0"];
     e1 = data["e1"];
     nx = data["nx"];
     ny = data["ny"];
     new_nodes = data["new_nodes"];
     node_routes = data["node_routes"];
     for (var i=0; i<e0.length; i++) {
       p0 = [[nx[e0[i]], nx[e1[i]]],
             [ny[e0[i]], ny[e1[i]]]];
       lines.push(p0);
     }
     for (var i=0; i<new_nodes.length; i++) {
       px.push([nx[new_nodes[i]], ny[new_nodes[i]], new_nodes[i]]);
     }

     var ret = plot_xy("#plot", [],
                       options={ x_label: "",
                                 y_label: "",
                                 circle_arrays: [px],
                                 circle_arrays_colors: [d3.color("red")],
                                 ymin: ymin,
                                 ymax: ymax,
                                 xmin: xmin,
                                 xmax: xmax,
                                 colors: [d3.color("grey")],
                                 height: height,
                                 width: width,
                                 callback: callback,
                                 padding: {top: 0, right: 0, bottom: 0, left: 0},});
     valueline = ret[0];
     xscale = ret[1];
     yscale = ret[2];
     d3.select("#node"+new_nodes[new_nodes.length-1]).attr("fill", "#000");
     current_node = new_nodes[new_nodes.length-1];
     new_nodes = new_nodes.filter(function(item) {return item !== current_node});
   });
  </script>
</html>
